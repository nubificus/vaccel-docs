
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../img/vaccel-img-logo.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Google Coral TPU - vAccel</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#google-coral-tpu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="vAccel" class="md-header__button md-logo" aria-label="vAccel" data-md-component="logo">
      
  <img src="../img/vaccel-logo-full.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            vAccel
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Google Coral TPU
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3m0-4.5c5 0 9.27 3.11 11 7.5-1.73 4.39-6 7.5-11 7.5S2.73 16.39 1 12c1.73-4.39 6-7.5 11-7.5M3.18 12a9.821 9.821 0 0 0 17.64 0 9.821 9.821 0 0 0-17.64 0Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="vAccel" class="md-nav__button md-logo" aria-label="vAccel" data-md-component="logo">
      
  <img src="../img/vaccel-logo-full.svg" alt="logo">

    </a>
    vAccel
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../user-guide/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user-guide/building/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build & Install from source
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user-guide/binaries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install from binary packages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user-guide/build-run-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build and run a vAccel application
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user-guide/vm-example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run a vAccel application in a VM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user-guide/remote-example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run a vAccel application remotely
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../language_bindings/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Framework & Language bindings
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Framework & Language bindings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python_bindings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python bindings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tensorflow_bindings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tensorflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pytorch_bindings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PyTorch [WiP]
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vaccel_go/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Go Bindings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../container_runtimes/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Container runtimes
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Container runtimes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kata_vaccel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kata-containers with vAccel
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../unikernels/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Unikernels
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Unikernels
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unikernels/unikraft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to run a vAccel application using Unikraft
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../dev_guide/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Developer Guide
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Developer Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vAccel User API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plugin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vAccel plugin API
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../misc_docs/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Useful Docs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Useful Docs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jetson/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jetson Inference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tensorflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pytorch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PyTorch
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#patch-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Patch the code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-the-latest-edge-tpu-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Download the latest Edge TPU runtime
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-and-build-tensorflow" class="md-nav__link">
    <span class="md-ellipsis">
      Download and build Tensorflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-the-shared-library" class="md-nav__link">
    <span class="md-ellipsis">
      Build the shared library
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-vaccel-plugin" class="md-nav__link">
    <span class="md-ellipsis">
      Build vAccel plugin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-files" class="md-nav__link">
    <span class="md-ellipsis">
      Extra Files
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="google-coral-tpu">Google Coral TPU</h1>
<p>To build the vAccel Google Coral TPU plugin, we will use a simple image classification example based on <code>tflite</code></p>
<p>To execute an image classification operation on the Google Coral TPU, we first
need to implement the operation using one of the available acceleration
frameworks and then register this function to the vAccel plugin we are
building. </p>
<p>To achieve this, we patch a <code>tflite</code> example for Google coral, and
build the available image classification function as a shared library, exposing
the following API to the relevant plugin:</p>
<pre><code class="language-c">int coral_classify(char *model_file_ptr,
                   char *label_file_ptr,
                   char *image_file_ptr,
                   float thres,
                   char **tags,
                   size_t *out_len) 
</code></pre>
<h2 id="patch-the-code">Patch the code</h2>
<p>The first step in order to build the library is to get the example code from
the Google Coral github repo:</p>
<pre><code>git clone https://github.com/google-coral/tflite
</code></pre>
<p>Then we need to apply the following patch (<code>libify_classify.patch</code>) to the relevant example:</p>
<pre><code class="language-patch">diff --git a/cpp/examples/classification/classify.cc b/cpp/examples/classification/classify.cc
index 69dfe04..1129976 100644
--- a/cpp/examples/classification/classify.cc
+++ b/cpp/examples/classification/classify.cc
@@ -22,6 +22,72 @@ int32_t ToInt32(const char p[4]) {
   return (p[3] &lt;&lt; 24) | (p[2] &lt;&lt; 16) | (p[1] &lt;&lt; 8) | p[0];
 }

+std::vector&lt;uint8_t&gt; ReadBmpImageFromBuf(char* buf,
+                                  int* out_width = nullptr,
+                                  int* out_height = nullptr,
+                                  int* out_channels = nullptr) {
+  char header[kBmpHeaderSize];
+  memcpy(header, buf, sizeof(header));
+
+  const char* file_header = header;
+  const char* info_header = header + kBmpFileHeaderSize;
+  char *ptr = buf + sizeof(header);
+
+  if (file_header[0] != 'B' || file_header[1] != 'M')
+    return {};  // Invalid file type.
+
+  const int channels = info_header[14] / 8;
+  if (channels != 1 &amp;&amp; channels != 3) return {};  // Unsupported bits per pixel.
+
+  if (ToInt32(&amp;info_header[16]) != 0) return {};  // Unsupported compression.
+
+  uint32_t offset = ToInt32(&amp;file_header[10]);
+#if 0
+  if (offset &gt; kBmpHeaderSize)// &amp;&amp; 
+      //!file.seekg(offset - kBmpHeaderSize, std::ios::cur))
+    return {};  // Seek failed.
+#endif
+
+  offset -= kBmpHeaderSize;
+  //printf(&quot;kBmpFileHeaderSize:%d\n&quot;, kBmpFileHeaderSize);
+  //printf(&quot;kBmpHeaderSize:%d\n&quot;, kBmpHeaderSize);
+  //printf(&quot;offset:%d\n&quot;, offset);
+  ptr = ptr+offset;
+  int width = ToInt32(&amp;info_header[4]);
+  if (width &lt; 0) return {};  // Invalid width.
+
+  int height = ToInt32(&amp;info_header[8]);
+  const bool top_down = height &lt; 0;
+  if (top_down) height = -height;
+
+  const int line_bytes = width * channels;
+  const int line_padding_bytes =
+      4 * ((8 * channels * width + 31) / 32) - line_bytes;
+  std::vector&lt;uint8_t&gt; image(line_bytes * height);
+  for (int i = 0; i &lt; height; ++i) {
+    uint8_t* line = &amp;image[(top_down ? i : (height - 1 - i)) * line_bytes];
+    memcpy(line, ptr, line_bytes);
+#if 0
+    if (!file.read(reinterpret_cast&lt;char*&gt;(line), line_bytes))
+      return {};  // Read failed.
+    if (!file.seekg(line_padding_bytes, std::ios::cur))
+      return {};  // Seek failed.
+#endif
+    //printf(&quot;line_bytes: %d line_padding_bytes:%d\n&quot;, line_bytes, line_padding_bytes);
+    ptr = ptr + line_padding_bytes;
+    ptr = ptr + line_bytes;
+    if (channels == 3) {
+      for (int j = 0; j &lt; width; ++j) std::swap(line[3 * j], line[3 * j + 2]);
+    }
+  }
+
+  if (out_width) *out_width = width;
+  if (out_height) *out_height = height;
+  if (out_channels) *out_channels = channels;
+  return image;
+}
+
+
 std::vector&lt;uint8_t&gt; ReadBmpImage(const char* filename,
                                   int* out_width = nullptr,
                                   int* out_height = nullptr,
@@ -50,6 +116,9 @@ std::vector&lt;uint8_t&gt; ReadBmpImage(const char* filename,
       !file.seekg(offset - kBmpHeaderSize, std::ios::cur))
     return {};  // Seek failed.

+  printf(&quot;kBmpFileHeaderSize:%d\n&quot;, kBmpFileHeaderSize);
+  printf(&quot;kBmpHeaderSize:%d\n&quot;, kBmpHeaderSize);
+  printf(&quot;offset:%d\n&quot;, offset);
   int width = ToInt32(&amp;info_header[4]);
   if (width &lt; 0) return {};  // Invalid width.

@@ -63,6 +132,7 @@ std::vector&lt;uint8_t&gt; ReadBmpImage(const char* filename,
   std::vector&lt;uint8_t&gt; image(line_bytes * height);
   for (int i = 0; i &lt; height; ++i) {
     uint8_t* line = &amp;image[(top_down ? i : (height - 1 - i)) * line_bytes];
+    printf(&quot;line_bytes: %d line_padding_bytes:%d\n&quot;, line_bytes, line_padding_bytes);
     if (!file.read(reinterpret_cast&lt;char*&gt;(line), line_bytes))
       return {};  // Read failed.
     if (!file.seekg(line_padding_bytes, std::ios::cur))
@@ -117,18 +187,12 @@ std::vector&lt;std::pair&lt;int, float&gt;&gt; Sort(const std::vector&lt;float&gt;&amp; scores,
 }
 }  // namespace

-int main(int argc, char* argv[]) {
-  if (argc != 5) {
-    std::cerr &lt;&lt; argv[0]
-              &lt;&lt; &quot; &lt;model_file&gt; &lt;label_file&gt; &lt;image_file&gt; &lt;threshold&gt;&quot;
-              &lt;&lt; std::endl;
-    return 1;
-  }
-
-  const std::string model_file = argv[1];
-  const std::string label_file = argv[2];
-  const std::string image_file = argv[3];
-  const float threshold = std::stof(argv[4]);
+extern &quot;C&quot; int coral_classify(char *model_file_ptr, char *label_file_ptr, char *image_file_ptr, float thres, char **tags, size_t *out_len) 
+{
+  const std::string model_file (model_file_ptr);
+  const std::string label_file (label_file_ptr);
+  const std::string image_file (image_file_ptr);
+  const float threshold = thres;

   // Find TPU device.
   size_t num_devices;
@@ -151,7 +215,8 @@ int main(int argc, char* argv[]) {
   // Load image.
   int image_bpp, image_width, image_height;
   auto image =
-      ReadBmpImage(image_file.c_str(), &amp;image_width, &amp;image_height, &amp;image_bpp);
+      ReadBmpImageFromBuf(image_file_ptr, &amp;image_width, &amp;image_height, &amp;image_bpp);
+      //ReadBmpImage(image_file_ptr, &amp;image_width, &amp;image_height, &amp;image_bpp);
   if (image.empty()) {
     std::cerr &lt;&lt; &quot;Cannot read image from &quot; &lt;&lt; image_file &lt;&lt; std::endl;
     return 1;
@@ -174,7 +239,7 @@ int main(int argc, char* argv[]) {

   auto* delegate =
       edgetpu_create_delegate(device.type, device.path, nullptr, 0);
-  interpreter-&gt;ModifyGraphWithDelegate({delegate, edgetpu_free_delegate});
+  interpreter-&gt;ModifyGraphWithDelegate(delegate);

   // Allocate tensors.
   if (interpreter-&gt;AllocateTensors() != kTfLiteOk) {
@@ -204,9 +269,13 @@ int main(int argc, char* argv[]) {

   // Get interpreter output.
   auto results = Sort(Dequantize(*interpreter-&gt;output_tensor(0)), threshold);
+  *tags = strdup(GetLabel(labels, results[0].first).c_str());
+  *out_len = strlen(*tags);
+#if 0
   for (auto&amp; result : results)
     std::cout &lt;&lt; std::setw(7) &lt;&lt; std::fixed &lt;&lt; std::setprecision(5)
               &lt;&lt; result.second &lt;&lt; GetLabel(labels, result.first) &lt;&lt; std::endl;
+#endif

   return 0;
 }
</code></pre>
<pre><code>cd tflite
patch -p1 &lt; ../libify_classify.path
</code></pre>
<p>Alternatively you could just clone from our forked repo:</p>
<pre><code>git clone https://github.com/nubificus/tflite -b vaccel
</code></pre>
<p>Then, we need to install the requirements &amp; build tflite for google coral (could take some time, so please be patient ;-)).</p>
<h2 id="download-the-latest-edge-tpu-runtime">Download the latest Edge TPU runtime</h2>
<p>You can grab the latest Edge TPU runtime archive from
<a href="https://coral.ai/software/">https://coral.ai/software/</a>. Then extract it next
to the Makefile:</p>
<pre><code>cd tflite/cpp/examples/classification/
wget https://dl.google.com/coral/edgetpu_api/edgetpu_runtime_20200710.zip
</code></pre>
<h2 id="download-and-build-tensorflow">Download and build Tensorflow</h2>
<pre><code>git clone https://github.com/tensorflow/tensorflow.git
tensorflow/tensorflow/lite/tools/make/download_dependencies.sh
tensorflow/tensorflow/lite/tools/make/build_lib.sh
</code></pre>
<h2 id="build-the-shared-library">Build the shared library</h2>
<p>Finally, build the classify shared object that we will then link to the vAccel Google Coral TPU plugin.</p>
<pre><code class="language-sh">g++ -shared -fPIC -std=c++11 classify.cc
        -o /usr/local/lib/libclassify.so
        -I/data/tflite/cpp/examples/classification/edgetpu_runtime/libedgetpu/
        -Itensorflow/
        -Itensorflow//tensorflow/lite/tools/make/downloads/flatbuffers/include
        -Ltensorflow//tensorflow/lite/tools/make/gen/generic-aarch64_armv8-a/lib
        -Ledgetpu_runtime/libedgetpu/direct/aarch64/
        -l:libedgetpu.so.1.0 -lpthread -lm -ldl
        tensorflow/tensorflow/lite/tools/make/gen/linux_aarch64/lib/libtensorflow-lite.a
</code></pre>
<h2 id="build-vaccel-plugin">Build vAccel plugin</h2>
<p>Following the generic process for vAccel building (from <a href="../user-guide/building/">Building vAccel</a>) we now have to enable the vAccel Google Coral Edge TPU plugin.</p>
<p>In short, the previous steps for vAccel were the following<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>:</p>
<pre><code>git clone --recursive https://github.com/nubificus/vaccel -b feat_gcoral_plugin
cd vaccelrt
mkdir build
cd build
cmake ../
</code></pre>
<p>The additional step now is to enable the plugin via cmake:</p>
<pre><code>cd vaccelrt
mkdir build_coral &amp;&amp; cd build_coral
cmake ../ -DBUILD_PLUGIN_CORAL=ON
</code></pre>
<p>The output of the above command should be something like the following:</p>
<pre><code>-- The C compiler identification is GNU 8.3.0
-- The CXX compiler identification is GNU 8.3.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /usr/bin/c++
-- Check for working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Configuring done
-- Generating done
-- Build files have been written to: /data/vaccelrt/build_coral/googletest-download
Scanning dependencies of target googletest
[ 11%] Creating directories for 'googletest'
[ 22%] Performing download step (git clone) for 'googletest'
Cloning into 'googletest-src'...
Note: checking out 'release-1.8.1'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -b with the checkout command again. Example:

  git checkout -b &lt;new-branch-name&gt;

HEAD is now at 2fe3bd99 Merge pull request #1433 from dsacre/fix-clang-warnings
[ 33%] No patch step for 'googletest'
[ 44%] Performing update step for 'googletest'
[ 55%] No configure step for 'googletest'
[ 66%] No build step for 'googletest'
[ 77%] No install step for 'googletest'
[ 88%] No test step for 'googletest'
[100%] Completed 'googletest'
[100%] Built target googletest
-- Found PythonInterp: /usr/bin/python (found version &quot;2.7.16&quot;) 
-- Looking for pthread.h
-- Looking for pthread.h - found
-- Looking for pthread_create
-- Looking for pthread_create - not found
-- Check if compiler accepts -pthread
-- Check if compiler accepts -pthread - yes
-- Found Threads: TRUE  
-- Found rt: /usr/lib/aarch64-linux-gnu/librt.so  
Include directories: /data/vaccelrt/src
-- Configuring done
-- Generating done
-- Build files have been written to: /data/vaccelrt/build_coral
</code></pre>
<p>Finally, building the plugin is as simple as issuing a make command:</p>
<pre><code>make
</code></pre>
<p>The plugin is available at:</p>
<pre><code>vaccelrt/build_coral/plugins/coral/libvaccel-coral.so
</code></pre>
<h2 id="extra-files">Extra Files</h2>
<p>To run an example on the Google Coral Edge TPU, follow the instructions available at
<a href="../user-guide/build-run-app/#running-a-vaccel-application">Run a simple vAccel application</a>.</p>
<p>The files needed for classification are:</p>
<pre><code>mobilenet_v1_1.0_224_quant_edgetpu.tflite
imagenet_labels.txt
</code></pre>
<p>available for download from: <a href="https://github.com/google-coral/test_data">https://github.com/google-coral/test_data</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Support for Google Coral is <a href="https://github.com/nubificus/vaccel/pull/14">WiP</a>, and will be available shortly in the main branch.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2018 - 2023 Nubificus LTD
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>