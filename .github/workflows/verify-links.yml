name: "Verify Links"

on:
  workflow_call:
    inputs:
      actions-repo:
        type: string
        default: 'nubificus/vaccel'
      actions-rev:
        type: string
        default: 'main'
    secrets:
      GIT_CLONE_PAT:
        required: false

jobs:
  verify-links:
    name: Verify Links
    runs-on: [base-dind-2204-amd64]

    steps:
      - name: Checkout .github directory
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github
          repository: ${{ inputs.actions-repo }}
          ref: ${{ inputs.actions-rev }}

      - name: Initialize workspace
        uses: ./.github/actions/initialize-workspace
        with:
          submodules: 'false'
          remote-actions-repo: ${{ inputs.actions-repo }}
          token: ${{ secrets.GIT_CLONE_PAT || github.token }}

      - name: Build docs (strict)
        run: |
          sudo pip install -r requirements.txt
          mkdocs build --strict
          site_url_esc=$(sed 's/[.[\()*+?^${}|\&\/]/\\&/g' docs/CNAME)
          echo "SITE_URL_ESC=${site_url_esc}" >> "$GITHUB_ENV"

      - name: Check markdown links w/o macros
        uses: lycheeverse/lychee-action@v2
        with:
          args: --exclude '\[\[\s*.*?\s*\]\]' docs

      - name: Check external links in HTML
        uses: lycheeverse/lychee-action@v2
        with:
          args: --root-dir $(pwd)/site --exclude ^https://${{ env.SITE_URL_ESC }} site
